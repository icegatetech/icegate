name: icegate

services:
  minio:
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/ready"]
      interval: 5s
      timeout: 5s
      retries: 5

  minio-init:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
        mc alias set minio http://minio:9000 minioadmin minioadmin &&
        mc mb --ignore-existing minio/warehouse &&
        mc mb --ignore-existing minio/queue &&
        mc ilm rule add --expire-days 1 minio/queue &&
        mc mb --ignore-existing minio/jobs
      "

  nessie-init:
    image: busybox
    volumes:
      - nessie-data:/data
    command: ["sh", "-c", "chown -R 10000:10001 /data"]

  nessie:
    image: quay.io/projectnessie/nessie:0.105.7
    ports:
      - "19120:19120"
    environment:
      # Disable authentication
      nessie.server.authentication.enabled: "false"
      # Configure default warehouse
      nessie.catalog.default-warehouse: warehouse
      nessie.catalog.warehouses.warehouse.location: s3://warehouse/
      # S3 configuration for MinIO
      nessie.catalog.service.s3.default-options.endpoint: http://minio:9000/
      nessie.catalog.service.s3.default-options.path-style-access: "true"
      nessie.catalog.service.s3.default-options.region: us-east-1
      # S3 credentials via secret reference
      nessie.catalog.service.s3.default-options.access-key: "urn:nessie-secret:quarkus:nessie.catalog.secrets.access-key"
      nessie.catalog.secrets.access-key.name: minioadmin
      nessie.catalog.secrets.access-key.secret: minioadmin
      # MinIO compatibility
      AWS_REQUEST_CHECKSUM_CALCULATION: WHEN_REQUIRED
      AWS_RESPONSE_CHECKSUM_VALIDATION: WHEN_REQUIRED
      # RocksDB version store
      nessie.version.store.type: ROCKSDB
      nessie.version.store.persist.rocks.database-path: /data/rocksdb
    volumes:
      - nessie-data:/data
    depends_on:
      minio:
        condition: service_healthy
      nessie-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:19120/api/v2/config"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  migrate:
    build:
      context: ../..
      dockerfile: config/docker/Dockerfile
      args:
        PROFILE: ${PROFILE:-release}
    command: ["/usr/local/bin/maintain", "migrate", "create", "--config", "/etc/icegate/maintain.yaml"]
    volumes:
      - ./maintain.yaml:/etc/icegate/maintain.yaml:ro
    depends_on:
      nessie:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_REGION: us-east-1

  query:
    build:
      context: ../..
      dockerfile: config/docker/Dockerfile
      args:
        PROFILE: ${PROFILE:-release}
    command: ["/usr/local/bin/query", "run", "--config", "/etc/icegate/query.yaml"]
    deploy:
      replicas: ${QUERY_REPLICAS:-1}
    ports:
      - "3100:3100"
      - "9090:9090"
      - "3200:3200"
    volumes:
      - ./query.yaml:/etc/icegate/query.yaml:ro
    depends_on:
      migrate:
        condition: service_completed_successfully
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_REGION: us-east-1
      RUST_LOG: info
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
    develop:
      watch:
        - action: rebuild
          path: ../../crates

  ingest:
    build:
      context: ../..
      dockerfile: config/docker/Dockerfile
      args:
        PROFILE: ${PROFILE:-release}
    command: ["/usr/local/bin/ingest", "run", "--config", "/etc/icegate/ingest.yaml"]
    ports:
      - "4317:4317"
      - "4318:4318"
      - "9091:9091"
    volumes:
      - ./ingest.yaml:/etc/icegate/ingest.yaml:ro
    depends_on:
      migrate:
        condition: service_completed_successfully
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_REGION: us-east-1
      RUST_LOG: "info,icegate_ingest=debug,icegate_jobmanager=debug,icegate_queue=debug,icegate_common=debug,otel::tracing=debug,tonic_tracing_opentelemetry=debug,aws_sdk_s3=warn,aws_smithy_http=warn,aws_smithy_client=warn,aws_smithy_runtime=warn,aws_smithy_runtime_api=warn"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/4317' || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    develop:
      watch:
        - action: rebuild
          path: ../../crates
    deploy:
      resources:
        limits:
          memory: 3g
          cpus: 1

  grafana:
    image: grafana/grafana:12.3
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/etc/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
      GF_AUTH_DISABLE_LOGIN_FORM: "true"
    depends_on:
      query:
        condition: service_started

  otelgen:
    image: ghcr.io/krzko/otelgen:v0.5.2
    command: ["--otel-exporter-otlp-endpoint", "ingest:4317", "--insecure", "logs", "multi", "--workers", "10", "--duration", "0"]
    depends_on:
      ingest:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - load

  prometheus:
    image: prom/prometheus:v3.9.1
    ports:
      - "9092:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    depends_on:
      ingest:
        condition: service_started
      node-exporter:
        condition: service_started
      cadvisor:
        condition: service_started
    profiles:
      - monitoring

  jaeger:
    image: jaegertracing/all-in-one:1.76.0
    ports:
      - "16686:16686"
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
      SPAN_STORAGE_TYPE: "badger"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:14269/"]
      interval: 5s
      timeout: 5s
      retries: 5
    profiles:
      - monitoring

  node-exporter:
    image: prom/node-exporter:v1.10.2
    pid: host
    command:
      - --path.procfs=/host/proc
      - --path.sysfs=/host/sys
      - --path.rootfs=/host/root
      - --collector.filesystem.mount-points-exclude=^/(proc|sys|dev|etc|host|run)($$|/)
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host/root:ro,rslave
    restart: unless-stopped
    profiles:
      - monitoring

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.55.1
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /sys:/sys:ro
      - /var/run:/var/run:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
      - /etc/machine-id:/etc/machine-id:ro
    command:
      - --docker_only=true
      - --store_container_labels=false
      - --storage_duration=2m
      - --housekeeping_interval=10s
    restart: unless-stopped
    profiles:
      - monitoring

  trino:
    image: trinodb/trino:479
    ports:
      - "8082:8080"
    volumes:
      - ./trino/iceberg.properties:/etc/trino/catalog/iceberg.properties:ro
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_REGION: us-east-1
    depends_on:
      minio:
        condition: service_healthy
      nessie:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/usr/lib/trino/bin/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    profiles:
      - analytics

volumes:
  minio-data:
  prometheus-data:
  grafana-data:
  nessie-data:
